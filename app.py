import os
import re
import psycopg2
from psycopg2 import pool
import logging
from datetime import datetime
from flask import Flask, request, abort
from linebot import LineBotApi, WebhookHandler
from linebot.exceptions import InvalidSignatureError, LineBotApiError
from linebot.models import (
    MessageEvent, TextMessage, TextSendMessage, JoinEvent, FollowEvent,
    QuickReply, QuickReplyButton, MessageAction, FlexSendMessage
)

logging.basicConfig(level=logging.INFO)
app = Flask(__name__)

LINE_CHANNEL_ACCESS_TOKEN = os.environ.get('LINE_CHANNEL_ACCESS_TOKEN')
LINE_CHANNEL_SECRET = os.environ.get('LINE_CHANNEL_SECRET')
DATABASE_URL = os.environ.get('DATABASE_URL')

line_bot_api = LineBotApi(LINE_CHANNEL_ACCESS_TOKEN)
handler = WebhookHandler(LINE_CHANNEL_SECRET)

connection_pool = None

def get_connection_pool():
    global connection_pool
    if connection_pool is None:
        connection_pool = psycopg2.pool.SimpleConnectionPool(1, 10, DATABASE_URL)
    return connection_pool

def get_db_connection():
    try:
        pool = get_connection_pool()
        return pool.getconn()
    except Exception as e:
        app.logger.error(f"é€£ç·šæ± éŒ¯èª¤ï¼Œä½¿ç”¨ç›´æ¥é€£ç·š: {e}")
        return psycopg2.connect(DATABASE_URL)

def return_db_connection(conn):
    try:
        pool = get_connection_pool()
        pool.putconn(conn)
    except:
        if conn:
            conn.close()

WELCOME_MSG = (
    "ğŸ‘‹ å¤§å®¶å¥½ï¼æˆ‘æ˜¯æƒ…ä¾¶è¨˜å¸³å°å¹«æ‰‹\n\n"
    "âœ¨ åˆæ¬¡è¦‹é¢è«‹å…ˆè¨»å†Šï¼š\n"
    "ğŸ‘‰ è¼¸å…¥ã€Œæˆ‘æ˜¯ ä½ çš„åå­—ã€\n"
    "(ä¾‹å¦‚ï¼šæˆ‘æ˜¯ è€å…¬)\n\n"
    "ğŸ“ ã€æŒ‡ä»¤å¤§å…¨ã€‘\n"
    "1. è¨˜è‡ªå·± (æœ€å¸¸ç”¨)ï¼š\n"
    "   â€¢ æ™šé¤ 200\n"
    "   â€¢ é£²æ–™50 (ä¸ç”¨ç©ºæ ¼)\n\n"
    "2. è‡ªå‹•æ‹†å¸³ï¼š\n"
    "   â€¢ æ™šé¤ 400 å¹« 150\n\n"
    "3. çµç®—èˆ‡æŸ¥è©¢ï¼š\n"
    "   â€¢ çµç®—ï¼šé¡¯ç¤ºæœ¬æœˆæ¶ˆè²»æ—¥æ›†\n"
    "     ï¼ˆé»æ“Šæ—¥æœŸæŸ¥çœ‹ç•¶å¤©æ˜ç´°ï¼‰\n"
    "   â€¢ è€å…¬ çµç®—ï¼šåªçœ‹è€å…¬çš„\n\n"
    "4. ä¿®æ”¹èˆ‡åˆªé™¤ï¼š\n"
    "   â€¢ ç§»é™¤ é£²æ–™ï¼šåˆªé™¤æœ€æ–°ä¸€ç­†ã€Œé£²æ–™ã€\n"
    "   â€¢ ç§»é™¤æœ€å¾Œä¸€ç­†ï¼šåˆªé™¤å‰›å‰›è¨˜çš„é‚£ç­†\n"
    "   â€¢ æ¸…é™¤ï¼šå…¨éƒ¨åˆªå…‰å…‰\n\n"
    "ğŸ’¡ ä½¿ç”¨ä¸‹æ–¹å¿«é€ŸæŒ‰éˆ•æ›´æ–¹ä¾¿ï¼"
)

def create_quick_reply_buttons():
    buttons = [
        QuickReplyButton(action=MessageAction(label="çµç®—", text="çµç®—")),
        QuickReplyButton(action=MessageAction(label="èªªæ˜", text="èªªæ˜")),
        QuickReplyButton(action=MessageAction(label="ç§»é™¤æœ€å¾Œä¸€ç­†", text="ç§»é™¤æœ€å¾Œä¸€ç­†"))
    ]
    
    try:
        conn = get_db_connection()
        cur = conn.cursor()
        cur.execute("SELECT display_name FROM users ORDER BY user_id LIMIT 2")
        users = cur.fetchall()
        cur.close()
        return_db_connection(conn)
        
        for user in users:
            user_name = user[0]
            buttons.append(
                QuickReplyButton(
                    action=MessageAction(label=f"{user_name} çµç®—", text=f"{user_name} çµç®—")
                )
            )
    except Exception as e:
        app.logger.error(f"å»ºç«‹å¿«é€ŸæŒ‰éˆ•å¤±æ•—: {e}")
    
    return QuickReply(items=buttons)

_db_initialized = False

def init_db():
    global _db_initialized
    if _db_initialized:
        return
        
    try:
        conn = get_db_connection()
        cur = conn.cursor()
        
        cur.execute("""
            CREATE TABLE IF NOT EXISTS users (
                user_id TEXT PRIMARY KEY,
                display_name TEXT NOT NULL
            );
        """)
        
        cur.execute("""
            CREATE TABLE IF NOT EXISTS expenses (
                id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                user_id TEXT NOT NULL,
                item TEXT NOT NULL,
                amount INTEGER NOT NULL,
                created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('asia/taipei', now())
            );
        """)
        
        cur.execute("CREATE INDEX IF NOT EXISTS idx_expenses_user_id ON expenses(user_id);")
        cur.execute("CREATE INDEX IF NOT EXISTS idx_expenses_created_at ON expenses(created_at);")
        cur.execute("CREATE INDEX IF NOT EXISTS idx_expenses_user_created ON expenses(user_id, created_at);")
        
        conn.commit()
        cur.close()
        return_db_connection(conn)
        _db_initialized = True
        app.logger.info("è³‡æ–™åº«åˆå§‹åŒ–å®Œæˆï¼")
    except Exception as e:
        app.logger.error(f"è³‡æ–™åº«åˆå§‹åŒ–å¤±æ•—: {e}")
        if conn:
            return_db_connection(conn)

def get_user_name(user_id, conn=None):
    should_close = False
    if conn is None:
        conn = get_db_connection()
        should_close = True
    
    try:
        cur = conn.cursor()
        cur.execute("SELECT display_name FROM users WHERE user_id = %s", (user_id,))
        result = cur.fetchone()
        cur.close()
        
        if result:
            return result[0]
    except Exception as e:
        app.logger.error(f"æŸ¥è©¢ä½¿ç”¨è€…åç¨±å¤±æ•—: {e}")
    finally:
        if should_close:
            return_db_connection(conn)
    
    try:
        profile = line_bot_api.get_profile(user_id)
        return profile.display_name
    except:
        return f"ç”¨æˆ¶({user_id[:4]})"

def get_user_id_by_name(name):
    conn = None
    try:
        conn = get_db_connection()
        cur = conn.cursor()
        cur.execute("SELECT user_id FROM users WHERE display_name = %s", (name,))
        result = cur.fetchone()
        cur.close()
        if result:
            return result[0]
    except Exception as e:
        app.logger.error(f"æŸ¥è©¢ ID å¤±æ•—: {e}")
    finally:
        if conn:
            return_db_connection(conn)
    return None

def get_partner_id(my_user_id):
    conn = None
    try:
        conn = get_db_connection()
        cur = conn.cursor()
        cur.execute("SELECT user_id, display_name FROM users WHERE user_id != %s", (my_user_id,))
        rows = cur.fetchall()
        cur.close()
        
        if len(rows) == 1:
            return rows[0][0], rows[0][1]
    except Exception as e:
        app.logger.error(f"æŸ¥è©¢å¦ä¸€åŠå¤±æ•—: {e}")
    finally:
        if conn:
            return_db_connection(conn)
    return None, None

def calculate_debts(conn):
    """
    è¨ˆç®—æ¬ æ¬¾é—œä¿‚ä¸¦äº’ç›¸æŠµéŠ·
    è¿”å›: {debtor_name: {creditor_name: amount}}
    åªè¿”å›æŠµéŠ·å¾Œçš„æ·¨æ¬ æ¬¾
    """
    try:
        cur = conn.cursor()
        
        # ç²å–æ‰€æœ‰ä½¿ç”¨è€…æ˜ å°„
        cur.execute("SELECT user_id, display_name FROM users")
        users = {row[0]: row[1] for row in cur.fetchall()}
        
        # æŸ¥æ‰¾æ‰€æœ‰åŒ…å« "(éœ€çµ¦XXX)" çš„é …ç›®
        cur.execute("""
            SELECT user_id, item, amount
            FROM expenses
            WHERE item LIKE '%(éœ€çµ¦%)'
        """)
        
        debt_records = cur.fetchall()
        cur.close()
        
        # åˆå§‹åŒ–æ¬ æ¬¾çŸ©é™£ï¼ˆé›™å‘è¨˜éŒ„ï¼‰
        debt_matrix = {}
        
        # è§£ææ¯ç­†æ¬ æ¬¾è¨˜éŒ„
        for user_id, item, amount in debt_records:
            # æå–å‚µæ¬Šäººåå­— (å¾ "é …ç›® (éœ€çµ¦XXX)" ä¸­æå– XXX)
            match = re.search(r'\(éœ€çµ¦(.+?)\)', item)
            if match:
                creditor_name = match.group(1)
                debtor_name = users.get(user_id, user_id)
                
                # åˆå§‹åŒ–
                if debtor_name not in debt_matrix:
                    debt_matrix[debtor_name] = {}
                if creditor_name not in debt_matrix:
                    debt_matrix[creditor_name] = {}
                if creditor_name not in debt_matrix[debtor_name]:
                    debt_matrix[debtor_name][creditor_name] = 0
                if debtor_name not in debt_matrix[creditor_name]:
                    debt_matrix[creditor_name][debtor_name] = 0
                
                # ç´¯åŠ æ¬ æ¬¾
                debt_matrix[debtor_name][creditor_name] += amount
        
        # äº’ç›¸æŠµéŠ·ï¼Œè¨ˆç®—æ·¨æ¬ æ¬¾
        net_debts = {}
        processed_pairs = set()
        
        for debtor in debt_matrix:
            for creditor in debt_matrix[debtor]:
                # é¿å…é‡è¤‡è™•ç†åŒä¸€å°é—œä¿‚
                pair = tuple(sorted([debtor, creditor]))
                if pair in processed_pairs:
                    continue
                processed_pairs.add(pair)
                
                # ç²å–é›™å‘æ¬ æ¬¾é‡‘é¡
                debt_a_to_b = debt_matrix.get(debtor, {}).get(creditor, 0)
                debt_b_to_a = debt_matrix.get(creditor, {}).get(debtor, 0)
                
                # è¨ˆç®—æ·¨æ¬ æ¬¾
                net_amount = debt_a_to_b - debt_b_to_a
                
                if net_amount > 0:
                    # debtor æ¬  creditor
                    if debtor not in net_debts:
                        net_debts[debtor] = {}
                    net_debts[debtor][creditor] = net_amount
                elif net_amount < 0:
                    # creditor æ¬  debtor
                    if creditor not in net_debts:
                        net_debts[creditor] = {}
                    net_debts[creditor][debtor] = abs(net_amount)
                # net_amount == 0 è¡¨ç¤ºäº’ç›¸æŠµéŠ·å®Œç•¢ï¼Œä¸è¨˜éŒ„
        
        return net_debts
        
    except Exception as e:
        app.logger.error(f"è¨ˆç®—æ¬ æ¬¾å¤±æ•—: {e}")
        return {}

def create_calendar_flex_message(year, month, conn):
    """
    å‰µå»ºæœˆæ›†å¼çš„ Flex Message
    """
    from calendar import monthrange
    import calendar as cal
    
    # ç²å–è©²æœˆä»½çš„è³‡æ–™
    first_day, num_days = monthrange(year, month)
    
    # æŸ¥è©¢è©²æœˆçš„æ¯æ—¥æ¶ˆè²»ï¼ˆæŒ‰äººåˆ†çµ„ï¼‰
    cur = conn.cursor()
    cur.execute("""
        SELECT 
            DATE(e.created_at) as date,
            COALESCE(u.display_name, e.user_id) as name,
            SUM(e.amount) as total
        FROM expenses e
        LEFT JOIN users u ON e.user_id = u.user_id
        WHERE EXTRACT(YEAR FROM e.created_at) = %s
        AND EXTRACT(MONTH FROM e.created_at) = %s
        GROUP BY DATE(e.created_at), u.display_name, e.user_id
        ORDER BY date
    """, (year, month))
    
    daily_records = cur.fetchall()
    
    # é‡çµ„è³‡æ–™çµæ§‹ï¼š{æ—¥æœŸ: {åå­—: é‡‘é¡}}
    daily_data = {}
    for row in daily_records:
        date_str = str(row[0])
        name = row[1]
        amount = row[2]
        if date_str not in daily_data:
            daily_data[date_str] = {}
        daily_data[date_str][name] = amount
    
    # è¨ˆç®—ç¸½èŠ±è²»
    cur.execute("""
        SELECT SUM(amount) as total
        FROM expenses
        WHERE EXTRACT(YEAR FROM created_at) = %s
        AND EXTRACT(MONTH FROM created_at) = %s
    """, (year, month))
    monthly_total = cur.fetchone()[0] or 0
    
    # ç²å–æ‰€æœ‰ç”¨æˆ¶ï¼ˆç”¨æ–¼çµ±è¨ˆï¼‰
    cur.execute("SELECT user_id, display_name FROM users")
    users_list = cur.fetchall()
    user_names = [u[1] for u in users_list]
    
    # è¨ˆç®—æœ¬æœˆå„äººç¸½æ¶ˆè²»
    cur.execute("""
        SELECT 
            COALESCE(u.display_name, e.user_id) as name,
            SUM(e.amount) as total
        FROM expenses e
        LEFT JOIN users u ON e.user_id = u.user_id
        WHERE EXTRACT(YEAR FROM e.created_at) = %s
        AND EXTRACT(MONTH FROM e.created_at) = %s
        GROUP BY u.display_name, e.user_id
        ORDER BY total DESC
    """, (year, month))
    
    monthly_user_totals = cur.fetchall()
    
    cur.close()
    
    # è¨ˆç®—ç¸½æ¬ æ¬¾
    debts = calculate_debts(conn)
    total_debt_text = ""
    if debts:
        debt_lines = []
        for debtor, creditors in debts.items():
            for creditor, amount in creditors.items():
                debt_lines.append(f"{debtor}æ¬ {creditor} ${amount}")
        total_debt_text = " | ".join(debt_lines)
    else:
        total_debt_text = "ç„¡æœªçµæ¸…æ¬ æ¬¾"
    
    # å‰µå»ºæ—¥æ›†æ ¼å­
    week_names = ["æ—¥", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­"]
    
    # æ¨™é¡Œåˆ—ï¼ˆæ˜ŸæœŸï¼‰
    header_boxes = []
    for day_name in week_names:
        header_boxes.append({
            "type": "box",
            "layout": "vertical",
            "contents": [
                {
                    "type": "text",
                    "text": day_name,
                    "size": "xs",
                    "align": "center",
                    "color": "#888888"
                }
            ],
            "width": "40px",
            "height": "20px"
        })
    
    # æ—¥æœŸæ ¼å­
    calendar_rows = []
    current_row = []
    
    # è£œè¶³ç¬¬ä¸€é€±çš„ç©ºç™½
    for i in range(first_day):
        current_row.append({
            "type": "box",
            "layout": "vertical",
            "contents": [],
            "width": "40px",
            "height": "55px"
        })
    
    # å¡«å…¥æ—¥æœŸ
    for day in range(1, num_days + 1):
        date_str = f"{year}-{month:02d}-{day:02d}"
        has_expense = date_str in daily_data
        
        # æ§‹å»ºæ—¥æœŸæ ¼å­çš„å…§å®¹
        day_contents = [
            {
                "type": "text",
                "text": str(day),
                "size": "sm",
                "align": "center",
                "color": "#1DB446" if has_expense else "#666666",
                "weight": "bold" if has_expense else "regular"
            }
        ]
        
        # å¦‚æœæœ‰æ¶ˆè²»è¨˜éŒ„ï¼Œé¡¯ç¤ºæ¯å€‹äººçš„é‡‘é¡
        if has_expense:
            for name, amount in daily_data[date_str].items():
                # å–åå­—çš„ç¬¬ä¸€å€‹å­—æˆ–å‰å…©å€‹å­—
                short_name = name[:2] if len(name) > 1 else name
                day_contents.append({
                    "type": "text",
                    "text": f"{short_name}${amount}",
                    "size": "xxs",
                    "align": "center",
                    "color": "#1DB446",
                    "margin": "none"
                })
        
        day_box = {
            "type": "box",
            "layout": "vertical",
            "contents": day_contents,
            "width": "40px",
            "height": "55px",
            "backgroundColor": "#E8F5E9" if has_expense else "#FFFFFF",
            "cornerRadius": "5px",
            "paddingAll": "2px",
            "action": {
                "type": "message",
                "label": f"{month}/{day}",
                "text": f"{year}-{month:02d}-{day:02d} æŸ¥è©¢"
            }
        }
        
        current_row.append(day_box)
        
        # æ¯é€±å…­æ›è¡Œ
        if (first_day + day) % 7 == 0:
            calendar_rows.append({
                "type": "box",
                "layout": "horizontal",
                "contents": current_row,
                "spacing": "sm"
            })
            current_row = []
    
    # æœ€å¾Œä¸€è¡Œä¸æ»¿7å¤©çš„è™•ç†
    if current_row:
        while len(current_row) < 7:
            current_row.append({
                "type": "box",
                "layout": "vertical",
                "contents": [],
                "width": "40px",
                "height": "55px"
            })
        calendar_rows.append({
            "type": "box",
            "layout": "horizontal",
            "contents": current_row,
            "spacing": "sm"
        })
    
    # çµ„åˆæœ¬æœˆå„äººçµ±è¨ˆ
    user_stats_contents = []
    for row in monthly_user_totals:
        name = row[0]
        total = row[1]
        user_stats_contents.append({
            "type": "box",
            "layout": "baseline",
            "spacing": "sm",
            "contents": [
                {
                    "type": "text",
                    "text": f"ğŸ‘¤ {name}:",
                    "size": "sm",
                    "color": "#666666",
                    "flex": 0
                },
                {
                    "type": "text",
                    "text": f"${total}",
                    "size": "sm",
                    "color": "#1DB446",
                    "align": "end",
                    "weight": "bold"
                }
            ]
        })
    
    # çµ„åˆå®Œæ•´çš„ Flex Message
    flex_content = {
        "type": "bubble",
        "body": {
            "type": "box",
            "layout": "vertical",
            "contents": [
                {
                    "type": "text",
                    "text": f"{year}å¹´{month}æœˆ æ¶ˆè²»æ—¥æ›†",
                    "weight": "bold",
                    "size": "lg",
                    "align": "center",
                    "color": "#1DB446"
                },
                {
                    "type": "box",
                    "layout": "vertical",
                    "margin": "md",
                    "spacing": "sm",
                    "contents": [
                        {
                            "type": "box",
                            "layout": "baseline",
                            "spacing": "sm",
                            "contents": [
                                {
                                    "type": "text",
                                    "text": "ğŸ’° æœ¬æœˆç¸½èŠ±è²»:",
                                    "size": "sm",
                                    "color": "#666666",
                                    "flex": 0
                                },
                                {
                                    "type": "text",
                                    "text": f"${monthly_total}",
                                    "size": "sm",
                                    "color": "#1DB446",
                                    "align": "end",
                                    "weight": "bold"
                                }
                            ]
                        }
                    ] + user_stats_contents + [
                        {
                            "type": "box",
                            "layout": "baseline",
                            "spacing": "sm",
                            "contents": [
                                {
                                    "type": "text",
                                    "text": "ğŸ’³ ç¸½æ¬ æ¬¾:",
                                    "size": "sm",
                                    "color": "#666666",
                                    "flex": 0
                                },
                                {
                                    "type": "text",
                                    "text": total_debt_text,
                                    "size": "xs",
                                    "color": "#FF6B6B" if debts else "#1DB446",
                                    "align": "end",
                                    "wrap": True
                                }
                            ]
                        }
                    ]
                },
                {
                    "type": "separator",
                    "margin": "md"
                },
                {
                    "type": "box",
                    "layout": "horizontal",
                    "contents": header_boxes,
                    "spacing": "sm",
                    "margin": "md"
                },
                {
                    "type": "separator",
                    "margin": "sm"
                }
            ] + calendar_rows + [
                {
                    "type": "box",
                    "layout": "vertical",
                    "margin": "md",
                    "contents": [
                        {
                            "type": "text",
                            "text": "é»æ“Šæ—¥æœŸæŸ¥çœ‹ç•¶å¤©è©³ç´°èŠ±è²»",
                            "size": "xs",
                            "color": "#888888",
                            "align": "center"
                        }
                    ]
                }
            ],
            "spacing": "sm"
        }
    }
    
    return FlexSendMessage(alt_text=f"{year}å¹´{month}æœˆæ¶ˆè²»æ—¥æ›†", contents=flex_content)
    """
    è¨ˆç®—æ¬ æ¬¾é—œä¿‚
    è¿”å›: {debtor_name: {creditor_name: amount}}
    """
    try:
        cur = conn.cursor()
        
        # ç²å–æ‰€æœ‰ä½¿ç”¨è€…æ˜ å°„
        cur.execute("SELECT user_id, display_name FROM users")
        users = {row[0]: row[1] for row in cur.fetchall()}
        
        # æŸ¥æ‰¾æ‰€æœ‰åŒ…å« "(éœ€çµ¦XXX)" çš„é …ç›®
        cur.execute("""
            SELECT user_id, item, amount
            FROM expenses
            WHERE item LIKE '%(éœ€çµ¦%)'
        """)
        
        debt_records = cur.fetchall()
        cur.close()
        
        # åˆå§‹åŒ–æ¬ æ¬¾å­—å…¸
        debts = {}
        
        # è§£ææ¯ç­†æ¬ æ¬¾è¨˜éŒ„
        for user_id, item, amount in debt_records:
            # æå–å‚µæ¬Šäººåå­— (å¾ "é …ç›® (éœ€çµ¦XXX)" ä¸­æå– XXX)
            match = re.search(r'\(éœ€çµ¦(.+?)\)', item)
            if match:
                creditor_name = match.group(1)
                debtor_name = users.get(user_id, user_id)
                
                # åˆå§‹åŒ–å‚µå‹™äººå­—å…¸
                if debtor_name not in debts:
                    debts[debtor_name] = {}
                
                # ç´¯åŠ æ¬ æ¬¾
                if creditor_name not in debts[debtor_name]:
                    debts[debtor_name][creditor_name] = 0
                debts[debtor_name][creditor_name] += amount
        
        return debts
        
    except Exception as e:
        app.logger.error(f"è¨ˆç®—æ¬ æ¬¾å¤±æ•—: {e}")
        return {}

@app.route("/callback", methods=['POST'])
def callback():
    init_db()
    
    signature = request.headers.get('X-Line-Signature', '')
    body = request.get_data(as_text=True)
    app.logger.info(f"Request body: {body}")

    try:
        handler.handle(body, signature)
    except InvalidSignatureError:
        app.logger.error("Invalid signature.")
        abort(400)
    return 'OK'

@handler.add(FollowEvent)
def handle_follow(event):
    line_bot_api.reply_message(
        event.reply_token, 
        TextSendMessage(text=WELCOME_MSG, quick_reply=create_quick_reply_buttons())
    )

@handler.add(JoinEvent)
def handle_join(event):
    line_bot_api.reply_message(
        event.reply_token, 
        TextSendMessage(text=WELCOME_MSG, quick_reply=create_quick_reply_buttons())
    )

@handler.add(MessageEvent, message=TextMessage)
def handle_message(event):
    msg = event.message.text.strip()
    sender_id = event.source.user_id

    if msg == "æˆ‘æ„›ä½ ":
        line_bot_api.reply_message(
            event.reply_token, 
            TextSendMessage(text="æˆ‘ä¹Ÿæ„›ä½ å€‘çˆ¸çˆ¸åª½åª½ â¤ï¸", quick_reply=create_quick_reply_buttons())
        )
        return

    if msg in ["èªªæ˜", "æŒ‡ä»¤", "help", "Help"]:
        line_bot_api.reply_message(
            event.reply_token, 
            TextSendMessage(text=WELCOME_MSG, quick_reply=create_quick_reply_buttons())
        )
        return
    
    if msg.startswith("æˆ‘æ˜¯"):
        name = msg[2:].strip()
        if name:
            conn = None
            try:
                conn = get_db_connection()
                cur = conn.cursor()
                cur.execute("""
                    INSERT INTO users (user_id, display_name) 
                    VALUES (%s, %s)
                    ON CONFLICT (user_id) 
                    DO UPDATE SET display_name = EXCLUDED.display_name;
                """, (sender_id, name))
                conn.commit()
                cur.close()
                line_bot_api.reply_message(
                    event.reply_token, 
                    TextSendMessage(text=f"âœ… æ­¡è¿ {name}ï¼å·²è¨˜ä½ä½ çš„åå­—ã€‚", quick_reply=create_quick_reply_buttons())
                )
            except Exception as e:
                app.logger.error(f"è¨­å®šåå­—å¤±æ•—: {e}")
                line_bot_api.reply_message(
                    event.reply_token, 
                    TextSendMessage(text="âŒ è¨­å®šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚", quick_reply=create_quick_reply_buttons())
                )
            finally:
                if conn:
                    return_db_connection(conn)
        return

    if msg == "ç§»é™¤æœ€å¾Œä¸€ç­†":
        conn = None
        try:
            conn = get_db_connection()
            cur = conn.cursor()
            cur.execute("SELECT id, user_id, amount, item, created_at FROM expenses ORDER BY created_at DESC LIMIT 1")
            row = cur.fetchone()
            if row:
                cur.execute("DELETE FROM expenses WHERE id = %s", (row[0],))
                conn.commit()
                name = get_user_name(row[1], conn)
                date_str = row[4].strftime("%m/%d")
                reply_text = f"ğŸ—‘ï¸ å·²ç§»é™¤æœ€æ–°ä¸€ç­†ç´€éŒ„ï¼š\n{date_str} {name}: {row[3]} ${row[2]}"
            else:
                reply_text = "ğŸ“­ ç›®å‰æ²’æœ‰ä»»ä½•ç´€éŒ„å¯ä»¥ç§»é™¤å–”ï¼"
            cur.close()
            line_bot_api.reply_message(
                event.reply_token, 
                TextSendMessage(text=reply_text, quick_reply=create_quick_reply_buttons())
            )
        except Exception as e:
            app.logger.error(f"DB Error: {e}")
            line_bot_api.reply_message(
                event.reply_token,
                TextSendMessage(text="âŒ ç§»é™¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚", quick_reply=create_quick_reply_buttons())
            )
        finally:
            if conn:
                return_db_connection(conn)
        return

    match_remove = re.match(r'^ç§»é™¤\s+(.+)$', msg)
    if match_remove:
        item_to_remove = match_remove.group(1).strip()
        conn = None
        try:
            conn = get_db_connection()
            cur = conn.cursor()
            cur.execute("""
                SELECT id, user_id, amount, created_at 
                FROM expenses 
                WHERE item = %s 
                ORDER BY created_at DESC 
                LIMIT 1
            """, (item_to_remove,))
            row = cur.fetchone()
            
            if row:
                cur.execute("DELETE FROM expenses WHERE id = %s", (row[0],))
                conn.commit()
                name = get_user_name(row[1], conn)
                date_str = row[3].strftime("%m/%d")
                reply_text = f"ğŸ—‘ï¸ å·²ç§»é™¤ï¼š\n{date_str} {name}: {item_to_remove} ${row[2]}"
            else:
                reply_text = f"âŒ æ‰¾ä¸åˆ°åç¨±ç‚ºã€Œ{item_to_remove}ã€çš„ç´€éŒ„ï¼"
            
            cur.close()
            line_bot_api.reply_message(
                event.reply_token, 
                TextSendMessage(text=reply_text, quick_reply=create_quick_reply_buttons())
            )
        except Exception as e:
            app.logger.error(f"DB Error: {e}")
            line_bot_api.reply_message(
                event.reply_token,
                TextSendMessage(text="âŒ ç§»é™¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚", quick_reply=create_quick_reply_buttons())
            )
        finally:
            if conn:
                return_db_connection(conn)
        return

    pattern_split_explicit = r'^(?:(\d{4}[-/]\d{1,2}[-/]\d{1,2})\s*)?(.+?)\s*(\d+)\s*å¹«\s*(.+?)\s*(\d+)$'
    pattern_split_implicit = r'^(?:(\d{4}[-/]\d{1,2}[-/]\d{1,2})\s*)?(.+?)\s*(\d+)\s*å¹«\s*(\d+)$'
    
    match_explicit = re.match(pattern_split_explicit, msg)
    match_implicit = re.match(pattern_split_implicit, msg)
    
    if match_explicit or match_implicit:
        target_user_id = None
        target_user_name = None
        sender_name = get_user_name(sender_id)

        if match_implicit:
            date_str = match_implicit.group(1)
            item = match_implicit.group(2).strip()
            total_amount = int(match_implicit.group(3))
            split_amount = int(match_implicit.group(4))
            
            target_user_id, target_user_name = get_partner_id(sender_id)
            if not target_user_id:
                line_bot_api.reply_message(
                    event.reply_token, 
                    TextSendMessage(
                        text="âŒ ç„¡æ³•è‡ªå‹•åˆ¤æ–·å°è±¡ï¼\nå¦‚æœæ˜¯å¤šäººä½¿ç”¨ï¼Œè«‹æŒ‡å®šåå­—ï¼š\nä¾‹å¦‚ï¼šæ™šé¤ 400 å¹« è€å…¬ 150",
                        quick_reply=create_quick_reply_buttons()
                    )
                )
                return
        elif match_explicit:
            date_str = match_explicit.group(1)
            item = match_explicit.group(2).strip()
            total_amount = int(match_explicit.group(3))
            target_name_input = match_explicit.group(4).strip()
            split_amount = int(match_explicit.group(5))
            
            target_user_id = get_user_id_by_name(target_name_input)
            if target_user_id:
                target_user_name = target_name_input
            else:
                line_bot_api.reply_message(
                    event.reply_token, 
                    TextSendMessage(
                        text=f"âŒ æ‰¾ä¸åˆ°ã€Œ{target_name_input}ã€ï¼\nè«‹ç¢ºèªå°æ–¹æœ‰è¼¸å…¥ã€Œæˆ‘æ˜¯ {target_name_input}ã€è¨»å†Šéã€‚",
                        quick_reply=create_quick_reply_buttons()
                    )
                )
                return

        self_amount = total_amount - split_amount
        created_at_val = "now()"
        display_date = "ä»Šå¤©"
        if date_str:
            try:
                datetime.strptime(date_str, "%Y-%m-%d")
                created_at_val = f"'{date_str} 12:00:00'"
                display_date = date_str
            except ValueError:
                line_bot_api.reply_message(
                    event.reply_token, 
                    TextSendMessage(text="âŒ æ—¥æœŸæ ¼å¼è«‹ç”¨ YYYY-MM-DD", quick_reply=create_quick_reply_buttons())
                )
                return

        conn = None
        try:
            conn = get_db_connection()
            cur = conn.cursor()
            
            sql = "INSERT INTO expenses (user_id, item, amount, created_at) VALUES (%s, %s, %s, " + created_at_val + ")" if created_at_val != "now()" else "INSERT INTO expenses (user_id, item, amount) VALUES (%s, %s, %s)"
            
            cur.execute(sql, (sender_id, item, self_amount))
            note_item = f"{item} (éœ€çµ¦{sender_name})"
            cur.execute(sql, (target_user_id, note_item, split_amount))
            
            conn.commit()
            cur.close()
            
            reply_text = (
                f"âœ… è‡ªå‹•æ‹†å¸³å®Œæˆï¼\n"
                f"ğŸ“… æ™‚é–“ï¼š{display_date}\n"
                f"ğŸ›’ é …ç›®ï¼š{item} (ç¸½é¡ ${total_amount})\n"
                f"----------------\n"
                f"ğŸ‘¤ {sender_name}ï¼š${self_amount}\n"
                f"ğŸ‘¤ {target_user_name}ï¼š${split_amount}"
            )
            line_bot_api.reply_message(
                event.reply_token, 
                TextSendMessage(text=reply_text, quick_reply=create_quick_reply_buttons())
            )
            
        except Exception as e:
            app.logger.error(f"DB Error: {e}")
            line_bot_api.reply_message(
                event.reply_token, 
                TextSendMessage(text="âŒ æ‹†å¸³å¤±æ•—ï¼Œè³‡æ–™åº«éŒ¯èª¤", quick_reply=create_quick_reply_buttons())
            )
        finally:
            if conn:
                return_db_connection(conn)
        return

    pattern_general = r'^(?:(\d{4}[-/]\d{1,2}[-/]\d{1,2})\s*)?(.+?)\s*(\d+)$'
    match = re.match(pattern_general, msg)
    
    if match:
        date_str = match.group(1)
        text_content = match.group(2).strip()
        amount = int(match.group(3))
        
        tokens = text_content.split(None, 1)
        final_user_id = sender_id
        item = text_content 
        
        if len(tokens) == 2:
            possible_name = tokens[0]
            remaining_text = tokens[1]
            found_id = get_user_id_by_name(possible_name)
            if found_id:
                final_user_id = found_id
                item = remaining_text 

        created_at_val = "now()" 
        display_date = "ä»Šå¤©"
        if date_str:
            try:
                datetime.strptime(date_str, "%Y-%m-%d")
                created_at_val = f"'{date_str} 12:00:00'" 
                display_date = date_str
            except ValueError:
                line_bot_api.reply_message(
                    event.reply_token, 
                    TextSendMessage(text="âŒ æ—¥æœŸæ ¼å¼è«‹ç”¨ YYYY-MM-DD", quick_reply=create_quick_reply_buttons())
                )
                return

        conn = None
        try:
            conn = get_db_connection()
            cur = conn.cursor()
            
            if created_at_val == "now()":
                cur.execute(
                    "INSERT INTO expenses (user_id, item, amount) VALUES (%s, %s, %s)",
                    (final_user_id, item, amount)
                )
            else:
                cur.execute(
                    "INSERT INTO expenses (user_id, item, amount, created_at) VALUES (%s, %s, %s, %s)",
                    (final_user_id, item, amount, date_str)
                )
                
            conn.commit()
            
            final_user_name = get_user_name(final_user_id, conn)
            if final_user_id == sender_id:
                final_user_name = "ä½ " 

            cur.close()
            
            reply_msg = f"âœ… å·²è¨˜éŒ„ï¼\nğŸ“… æ™‚é–“ï¼š{display_date}\nğŸ‘¤ ä»˜æ¬¾ï¼š{final_user_name}\nğŸ›’ é …ç›®ï¼š{item}\nğŸ’° é‡‘é¡ï¼š${amount}"
            line_bot_api.reply_message(
                event.reply_token, 
                TextSendMessage(text=reply_msg, quick_reply=create_quick_reply_buttons())
            )
            
        except Exception as e:
            app.logger.error(f"Database Error: {e}")
            line_bot_api.reply_message(
                event.reply_token, 
                TextSendMessage(text="âŒ è¨˜å¸³å¤±æ•—ï¼Œè³‡æ–™åº«å‡ºéŒ¯äº†ã€‚", quick_reply=create_quick_reply_buttons())
            )
        finally:
            if conn:
                return_db_connection(conn)
        return

    # === æ—¥æœŸæŸ¥è©¢åŠŸèƒ½ï¼ˆå¾æ—¥æ›†é»æ“Šè§¸ç™¼ï¼‰===
    date_query_match = re.match(r'^(\d{4})-(\d{2})-(\d{2})\s*æŸ¥è©¢$', msg)
    if date_query_match:
        query_year = int(date_query_match.group(1))
        query_month = int(date_query_match.group(2))
        query_day = int(date_query_match.group(3))
        query_date = f"{query_year}-{query_month:02d}-{query_day:02d}"
        
        conn = None
        try:
            conn = get_db_connection()
            cur = conn.cursor()
            
            cur.execute("""
                SELECT 
                    COALESCE(u.display_name, e.user_id) as name,
                    e.item, 
                    e.amount
                FROM expenses e
                LEFT JOIN users u ON e.user_id = u.user_id
                WHERE DATE(e.created_at) = %s
                ORDER BY e.created_at ASC
            """, (query_date,))
            
            details = cur.fetchall()
            cur.close()
            
            if not details:
                line_bot_api.reply_message(
                    event.reply_token,
                    TextSendMessage(
                        text=f"ğŸ“… {query_month}/{query_day}\n\né€™å¤©æ²’æœ‰æ¶ˆè²»è¨˜éŒ„å–”ï¼",
                        quick_reply=create_quick_reply_buttons()
                    )
                )
                return
            
            reply_text = f"ğŸ“… {query_month}/{query_day} æ¶ˆè²»æ˜ç´°\n"
            reply_text += "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n"
            
            daily_total = 0
            for row in details:
                name = row[0]
                item = row[1]
                amt = row[2]
                daily_total += amt
                reply_text += f"{name}: {item} ${amt}\n"
            
            reply_text += "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n"
            reply_text += f"ğŸ’° ç•¶æ—¥ç¸½è¨ˆ: ${daily_total}"
            
            line_bot_api.reply_message(
                event.reply_token,
                TextSendMessage(text=reply_text, quick_reply=create_quick_reply_buttons())
            )
            
        except Exception as e:
            app.logger.error(f"æ—¥æœŸæŸ¥è©¢éŒ¯èª¤: {e}")
            line_bot_api.reply_message(
                event.reply_token,
                TextSendMessage(text="âŒ æŸ¥è©¢å¤±æ•—", quick_reply=create_quick_reply_buttons())
            )
        finally:
            if conn:
                return_db_connection(conn)
        return

    # === çµç®—åŠŸèƒ½ï¼ˆé¡¯ç¤ºæœˆæ›†ï¼‰===
    match_settle = re.match(r'^(?:(.+?)\s*)?çµç®—$', msg)
    
    if match_settle:
        specific_name = match_settle.group(1)
        conn = None
        
        try:
            conn = get_db_connection()
            cur = conn.cursor()
            
            # è¨ˆç®—æ¬ æ¬¾ï¼ˆå…¨åŸŸä½¿ç”¨ï¼‰
            debts = calculate_debts(conn)
            
            # === å€‹äººçµç®— ===
            if specific_name:
                target_uid = get_user_id_by_name(specific_name)
                
                if specific_name == "æˆ‘":
                    target_uid = sender_id
                    specific_name = get_user_name(sender_id, conn)

                if not target_uid:
                     line_bot_api.reply_message(
                         event.reply_token, 
                         TextSendMessage(
                             text=f"âŒ æ‰¾ä¸åˆ°ã€Œ{specific_name}ã€ï¼è«‹ç¢ºèªåå­—æœ‰è¨»å†Šéã€‚",
                             quick_reply=create_quick_reply_buttons()
                         )
                     )
                     return

                cur.execute("""
                    SELECT created_at, item, amount 
                    FROM expenses 
                    WHERE user_id = %s
                    ORDER BY created_at DESC
                """, (target_uid,))
                details = cur.fetchall()
                
                if not details:
                     line_bot_api.reply_message(
                         event.reply_token, 
                         TextSendMessage(
                             text=f"ğŸ‘¤ {specific_name} ç›®å‰é‚„æ²’æœ‰æ¶ˆè²»ç´€éŒ„å–”ï¼",
                             quick_reply=create_quick_reply_buttons()
                         )
                     )
                     return

                reply_text = f"ğŸ‘¤ {specific_name} çš„æ¶ˆè²»æ˜ç´°\n"
                
                # æŒ‰æ—¥æœŸåˆ†çµ„
                daily_records = {}
                total = 0
                for row in details:
                    dt = row[0]
                    item = row[1]
                    amt = row[2]
                    total += amt
                    date_key = dt.strftime("%Y-%m-%d")
                    if date_key not in daily_records:
                        daily_records[date_key] = []
                    daily_records[date_key].append(row)
                
                # æŒ‰æ—¥æœŸæ’åºï¼ˆæœ€è¿‘çš„åœ¨å‰ï¼‰
                sorted_dates = sorted(daily_records.keys(), reverse=True)
                
                # æœ€å¤šé¡¯ç¤ºæœ€è¿‘ 15 å¤©
                display_dates = sorted_dates[:15]
                
                for date in display_dates:
                    dt_obj = datetime.strptime(date, "%Y-%m-%d")
                    date_display = dt_obj.strftime("%m/%d (%a)")
                    
                    # æ—¥æœŸæ¨™é¡Œ
                    reply_text += f"\nğŸ“… {date_display}\n"
                    reply_text += "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n"
                    
                    # è©²æ—¥çš„æ‰€æœ‰è¨˜éŒ„
                    daily_total = 0
                    for row in daily_records[date]:
                        item = row[1]
                        amt = row[2]
                        daily_total += amt
                        reply_text += f"  {item} ${amt}\n"
                    
                    # æ¯æ—¥å°è¨ˆ
                    reply_text += f"  ğŸ’° ç•¶æ—¥å°è¨ˆ: ${daily_total}\n"
                
                if len(sorted_dates) > 15:
                    reply_text += f"\n... é‚„æœ‰ {len(sorted_dates) - 15} å¤©çš„è¨˜éŒ„æœªé¡¯ç¤º\n"
                
                reply_text += "\n================\n"
                reply_text += f"ğŸ’° å€‹äººç¸½æ”¯å‡º: ${total}\n"
                
                # é¡¯ç¤ºå€‹äººç›¸é—œçš„æ¬ æ¬¾
                if debts:
                    personal_debts = []
                    # æŸ¥çœ‹æ˜¯å¦æ¬ åˆ¥äººéŒ¢
                    if specific_name in debts:
                        for creditor, amount in debts[specific_name].items():
                            personal_debts.append(f"  æ¬  {creditor}: ${amount}")
                    # æŸ¥çœ‹æ˜¯å¦åˆ¥äººæ¬ è‡ªå·±éŒ¢
                    for debtor, creditors in debts.items():
                        if specific_name in creditors:
                            personal_debts.append(f"  {debtor} æ¬ ä½ : ${creditors[specific_name]}")
                    
                    if personal_debts:
                        reply_text += "\nğŸ’³ æ¬ æ¬¾é—œä¿‚ï¼š\n"
                        reply_text += "\n".join(personal_debts)
                    else:
                        reply_text += "\nâœ¨ ç›®å‰æ²’æœ‰æœªçµæ¸…çš„æ¬ æ¬¾ï¼"
                else:
                    reply_text += "\nâœ¨ ç›®å‰æ²’æœ‰æœªçµæ¸…çš„æ¬ æ¬¾ï¼"
                
                cur.close()
                line_bot_api.reply_message(
                    event.reply_token,
                    TextSendMessage(text=reply_text, quick_reply=create_quick_reply_buttons())
                )

            # === å…¨é«”çµç®—ï¼ˆé¡¯ç¤ºæœˆæ›†ï¼‰===
            else:
                # ç²å–ç•¶å‰å¹´æœˆ
                now = datetime.now()
                current_year = now.year
                current_month = now.month
                
                # ç”Ÿæˆæœˆæ›† Flex Message
                calendar_message = create_calendar_flex_message(current_year, current_month, conn)
                
                line_bot_api.reply_message(
                    event.reply_token,
                    calendar_message
                )

        except Exception as e:
            app.logger.error(f"Error: {e}")
            line_bot_api.reply_message(
                event.reply_token, 
                TextSendMessage(text="âŒ çµç®—ç™¼ç”ŸéŒ¯èª¤", quick_reply=create_quick_reply_buttons())
            )
        finally:
            if conn:
                return_db_connection(conn)
        return

    if msg == "æ¸…é™¤":
        conn = None
        try:
            conn = get_db_connection()
            cur = conn.cursor()
            cur.execute("DELETE FROM expenses")
            conn.commit()
            cur.close()
            line_bot_api.reply_message(
                event.reply_token, 
                TextSendMessage(
                    text="ğŸ—‘ï¸ å·²æ¸…é™¤æ‰€æœ‰è¨˜å¸³è³‡æ–™ï¼\nä¸€åˆ‡é‡æ–°é–‹å§‹ âœ¨",
                    quick_reply=create_quick_reply_buttons()
                )
            )
        except Exception as e:
            app.logger.error(f"DB Error: {e}")
            line_bot_api.reply_message(
                event.reply_token,
                TextSendMessage(text="âŒ æ¸…é™¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚", quick_reply=create_quick_reply_buttons())
            )
        finally:
            if conn:
                return_db_connection(conn)
        return
    
    # === é è¨­å›è¦†ï¼šç•¶è¨Šæ¯ä¸ç¬¦åˆä»»ä½•æŒ‡ä»¤æ™‚ ===
    line_bot_api.reply_message(
        event.reply_token,
        TextSendMessage(
            text="â“ æˆ‘ä¸å¤ªæ‡‚ä½ çš„æ„æ€\nè«‹é»é¸ä¸‹æ–¹æŒ‰éˆ•æˆ–è¼¸å…¥ã€Œèªªæ˜ã€æŸ¥çœ‹æŒ‡ä»¤",
            quick_reply=create_quick_reply_buttons()
        )
    )

@app.route("/", methods=['GET'])
def health_check():
    init_db()
    return "Bot is running!", 200

if __name__ == "__main__":
    port = int(os.environ.get('PORT', 5000))
    app.run(host='0.0.0.0', port=port)
