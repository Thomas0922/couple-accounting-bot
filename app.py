import os
import re
import psycopg2
import logging
from datetime import datetime
from flask import Flask, request, abort
from linebot import LineBotApi, WebhookHandler
from linebot.exceptions import InvalidSignatureError, LineBotApiError
from linebot.models import MessageEvent, TextMessage, TextSendMessage, JoinEvent, FollowEvent

# è¨­å®š Log é¡¯ç¤º (æ–¹ä¾¿é™¤éŒ¯)
logging.basicConfig(level=logging.INFO)
app = Flask(__name__)

# === 1. å¾ç’°å¢ƒè®Šæ•¸è®€å–è¨­å®š ===
LINE_CHANNEL_ACCESS_TOKEN = os.environ.get('LINE_CHANNEL_ACCESS_TOKEN')
LINE_CHANNEL_SECRET = os.environ.get('LINE_CHANNEL_SECRET')
DATABASE_URL = os.environ.get('DATABASE_URL')

# åˆå§‹åŒ– Line Bot
line_bot_api = LineBotApi(LINE_CHANNEL_ACCESS_TOKEN)
handler = WebhookHandler(LINE_CHANNEL_SECRET)

# === å®šç¾©æ­¡è¿è¨Šæ¯èˆ‡æŒ‡ä»¤èªªæ˜ ===
WELCOME_MSG = (
    "ğŸ‘‹ å¤§å®¶å¥½ï¼æˆ‘æ˜¯æƒ…ä¾¶è¨˜å¸³å°å¹«æ‰‹\n\n"
    "âœ¨ åˆæ¬¡è¦‹é¢è«‹å…ˆè¨»å†Šï¼š\n"
    "ğŸ‘‰ è¼¸å…¥ã€Œæˆ‘æ˜¯ ä½ çš„åå­—ã€\n"
    "(ä¾‹å¦‚ï¼šæˆ‘æ˜¯ è€å…¬)\n\n"
    "ğŸ“ ã€æŒ‡ä»¤å¤§å…¨ã€‘\n"
    "1. è¨˜è‡ªå·± (æœ€å¸¸ç”¨)ï¼š\n"
    "   â€¢ æ™šé¤ 200\n"
    "   â€¢ é£²æ–™50 (ä¸ç”¨ç©ºæ ¼ä¹Ÿè¡Œ)\n\n"
    "2. è‡ªå‹•æ‹†å¸³ï¼š\n"
    "   â€¢ æ™šé¤ 400 å¹« 150\n"
    "     (ç¸½é¡400ï¼Œå…¶ä¸­150å¹«å°æ–¹ä»˜)\n"
    "   â€¢ æ™šé¤ 400 å¹« è€å…¬ 150\n\n"
    "3. å¹«å°æ–¹è¨˜ (å…¨é¡)ï¼š\n"
    "   â€¢ è€å…¬ é£²æ–™ 50\n\n"
    "4. çµç®—åŠŸèƒ½ (âœ¨æ›´æ–°)ï¼š\n"
    "   â€¢ çµç®—ï¼šæŸ¥çœ‹æ‰€æœ‰äººæ˜ç´°\n"
    "   â€¢ è€å…¬ çµç®—ï¼šåªçœ‹è€å…¬çš„æ˜ç´°\n\n"
    "5. å…¶ä»–ï¼š\n"
    "   â€¢ æ¸…é™¤ï¼šåˆªé™¤è³‡æ–™é‡æ–°é–‹å§‹\n"
    "   â€¢ èªªæ˜ï¼šé¡¯ç¤ºæ­¤æ•™å­¸"
)

# === 2. è³‡æ–™åº«é€£ç·šè¼”åŠ©å‡½å¼ ===
def get_db_connection():
    conn = psycopg2.connect(DATABASE_URL)
    return conn

# === 3. åˆå§‹åŒ–è³‡æ–™åº« (è‡ªå‹•å»ºç«‹ä½¿ç”¨è€…è¡¨) ===
def init_db():
    try:
        conn = get_db_connection()
        cur = conn.cursor()
        # å»ºç«‹ users è¡¨ (å¦‚æœä¸å­˜åœ¨)
        cur.execute("""
            CREATE TABLE IF NOT EXISTS users (
                user_id TEXT PRIMARY KEY,
                display_name TEXT NOT NULL
            );
        """)
        # ç¢ºä¿ expenses è¡¨å­˜åœ¨
        cur.execute("""
            CREATE TABLE IF NOT EXISTS expenses (
                id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                user_id TEXT NOT NULL,
                item TEXT NOT NULL,
                amount INTEGER NOT NULL,
                created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('asia/taipei', now())
            );
        """)
        conn.commit()
        cur.close()
        conn.close()
        print("è³‡æ–™åº«åˆå§‹åŒ–å®Œæˆï¼")
    except Exception as e:
        print(f"è³‡æ–™åº«åˆå§‹åŒ–å¤±æ•—: {e}")

# æ‡‰ç”¨ç¨‹å¼å•Ÿå‹•æ™‚åŸ·è¡Œä¸€æ¬¡åˆå§‹åŒ–
with app.app_context():
    init_db()

# === 4. è¼”åŠ©å‡½å¼ ===
# å–å¾—ç”¨æˆ¶é¡¯ç¤ºåç¨± (User ID -> Name)
def get_user_name(user_id):
    try:
        conn = get_db_connection()
        cur = conn.cursor()
        cur.execute("SELECT display_name FROM users WHERE user_id = %s", (user_id,))
        result = cur.fetchone()
        cur.close()
        conn.close()
        if result:
            return result[0]
    except Exception as e:
        app.logger.error(f"æŸ¥è©¢ä½¿ç”¨è€…åç¨±å¤±æ•—: {e}")
    
    # è³‡æ–™åº«æ²’æœ‰ï¼Œè©¦è‘—å• LINE
    try:
        profile = line_bot_api.get_profile(user_id)
        return profile.display_name
    except:
        return f"ç”¨æˆ¶({user_id[:4]})"

# å–å¾—ç”¨æˆ¶ ID (Name -> User ID)
def get_user_id_by_name(name):
    try:
        conn = get_db_connection()
        cur = conn.cursor()
        cur.execute("SELECT user_id FROM users WHERE display_name = %s", (name,))
        result = cur.fetchone()
        cur.close()
        conn.close()
        if result:
            return result[0]
    except Exception as e:
        app.logger.error(f"æŸ¥è©¢ ID å¤±æ•—: {e}")
    return None

# å–å¾—ã€Œå¦ä¸€åŠã€çš„ ID (é©åˆåªæœ‰å…©å€‹äººçš„æ™‚å€™)
def get_partner_id(my_user_id):
    try:
        conn = get_db_connection()
        cur = conn.cursor()
        # æ‰¾å‡ºé™¤äº†è‡ªå·±ä»¥å¤–çš„æ‰€æœ‰ç”¨æˆ¶
        cur.execute("SELECT user_id, display_name FROM users WHERE user_id != %s", (my_user_id,))
        rows = cur.fetchall()
        cur.close()
        conn.close()
        
        # åªæœ‰ç•¶å‰©ä¸‹æ­£å¥½ 1 å€‹äººæ™‚ï¼Œæˆ‘å€‘æ‰èƒ½ç¢ºå®šã€Œå¦ä¸€åŠã€æ˜¯èª°
        if len(rows) == 1:
            return rows[0][0], rows[0][1] # return ID, Name
    except Exception as e:
        app.logger.error(f"æŸ¥è©¢å¦ä¸€åŠå¤±æ•—: {e}")
    return None, None

@app.route("/callback", methods=['POST'])
def callback():
    signature = request.headers.get('X-Line-Signature', '')
    body = request.get_data(as_text=True)
    app.logger.info(f"Request body: {body}")

    try:
        handler.handle(body, signature)
    except InvalidSignatureError:
        app.logger.error("Invalid signature.")
        abort(400)
    return 'OK'

# === åŠ å…¥å¥½å‹æ™‚çš„æ­¡è¿è© (1å°1) ===
@handler.add(FollowEvent)
def handle_follow(event):
    line_bot_api.reply_message(event.reply_token, TextSendMessage(text=WELCOME_MSG))

# === åŠ å…¥ç¾¤çµ„æ™‚çš„æ­¡è¿è© ===
@handler.add(JoinEvent)
def handle_join(event):
    line_bot_api.reply_message(event.reply_token, TextSendMessage(text=WELCOME_MSG))

@handler.add(MessageEvent, message=TextMessage)
def handle_message(event):
    msg = event.message.text.strip()
    sender_id = event.source.user_id

    # === åŠŸèƒ½ï¼šå°å½©è›‹ ===
    if msg == "æˆ‘æ„›ä½ ":
        line_bot_api.reply_message(event.reply_token, TextSendMessage(text="æˆ‘ä¹Ÿæ„›ä½ å€‘çˆ¸çˆ¸åª½åª½ â¤ï¸"))
        return

    # === åŠŸèƒ½ï¼šé¡¯ç¤ºèªªæ˜æŒ‡ä»¤ ===
    if msg in ["èªªæ˜", "æŒ‡ä»¤", "help", "Help"]:
        line_bot_api.reply_message(event.reply_token, TextSendMessage(text=WELCOME_MSG))
        return
    
    # === åŠŸèƒ½ Aï¼šè¨»å†Šåå­— (æ ¼å¼ï¼šæˆ‘æ˜¯ xxx) ===
    if msg.startswith("æˆ‘æ˜¯"):
        name = msg[2:].strip()
        if name:
            try:
                conn = get_db_connection()
                cur = conn.cursor()
                # ä½¿ç”¨ UPSERT
                cur.execute("""
                    INSERT INTO users (user_id, display_name) 
                    VALUES (%s, %s)
                    ON CONFLICT (user_id) 
                    DO UPDATE SET display_name = EXCLUDED.display_name;
                """, (sender_id, name))
                conn.commit()
                cur.close()
                conn.close()
                line_bot_api.reply_message(event.reply_token, TextSendMessage(text=f"âœ… æ­¡è¿ {name}ï¼å·²è¨˜ä½ä½ çš„åå­—ã€‚"))
            except Exception as e:
                app.logger.error(f"è¨­å®šåå­—å¤±æ•—: {e}")
                line_bot_api.reply_message(event.reply_token, TextSendMessage(text="âŒ è¨­å®šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚"))
        return

    # === åŠŸèƒ½ Bï¼šè‡ªå‹•æ‹†å¸³ (å„ªå…ˆåˆ¤æ–·) ===
    pattern_split_explicit = r'^(?:(\d{4}[-/]\d{1,2}[-/]\d{1,2})\s*)?(.+?)\s*(\d+)\s*å¹«\s*(.+?)\s*(\d+)$'
    pattern_split_implicit = r'^(?:(\d{4}[-/]\d{1,2}[-/]\d{1,2})\s*)?(.+?)\s*(\d+)\s*å¹«\s*(\d+)$'
    
    match_explicit = re.match(pattern_split_explicit, msg)
    match_implicit = re.match(pattern_split_implicit, msg)
    
    if match_explicit or match_implicit:
        target_user_id = None
        target_user_name = None
        
        sender_name = get_user_name(sender_id)

        if match_implicit:
            date_str = match_implicit.group(1)
            item = match_implicit.group(2).strip()
            total_amount = int(match_implicit.group(3))
            split_amount = int(match_implicit.group(4))
            
            target_user_id, target_user_name = get_partner_id(sender_id)
            if not target_user_id:
                line_bot_api.reply_message(event.reply_token, TextSendMessage(text="âŒ ç„¡æ³•è‡ªå‹•åˆ¤æ–·å°è±¡ï¼\nå¦‚æœæ˜¯å¤šäººä½¿ç”¨ï¼Œè«‹æŒ‡å®šåå­—ï¼š\nä¾‹å¦‚ï¼šæ™šé¤ 400 å¹« è€å…¬ 150"))
                return
        elif match_explicit:
            date_str = match_explicit.group(1)
            item = match_explicit.group(2).strip()
            total_amount = int(match_explicit.group(3))
            target_name_input = match_explicit.group(4).strip()
            split_amount = int(match_explicit.group(5))
            
            target_user_id = get_user_id_by_name(target_name_input)
            if target_user_id:
                target_user_name = target_name_input
            else:
                line_bot_api.reply_message(event.reply_token, TextSendMessage(text=f"âŒ æ‰¾ä¸åˆ°ã€Œ{target_name_input}ã€ï¼\nè«‹ç¢ºèªå°æ–¹æœ‰è¼¸å…¥ã€Œæˆ‘æ˜¯ {target_name_input}ã€è¨»å†Šéã€‚"))
                return

        self_amount = total_amount - split_amount
        created_at_val = "now()"
        display_date = "ä»Šå¤©"
        if date_str:
            try:
                datetime.strptime(date_str, "%Y-%m-%d")
                created_at_val = f"'{date_str} 12:00:00'"
                display_date = date_str
            except ValueError:
                line_bot_api.reply_message(event.reply_token, TextSendMessage(text="âŒ æ—¥æœŸæ ¼å¼è«‹ç”¨ YYYY-MM-DD"))
                return

        try:
            conn = get_db_connection()
            cur = conn.cursor()
            
            sql = "INSERT INTO expenses (user_id, item, amount, created_at) VALUES (%s, %s, %s, " + created_at_val + ")" if created_at_val != "now()" else "INSERT INTO expenses (user_id, item, amount) VALUES (%s, %s, %s)"
            
            cur.execute(sql, (sender_id, item, self_amount))
            note_item = f"{item} (éœ€çµ¦{sender_name})"
            cur.execute(sql, (target_user_id, note_item, split_amount))
            
            conn.commit()
            cur.close()
            conn.close()
            
            reply_text = (
                f"âœ… è‡ªå‹•æ‹†å¸³å®Œæˆï¼\n"
                f"ğŸ“… æ™‚é–“ï¼š{display_date}\n"
                f"ğŸ›’ é …ç›®ï¼š{item} (ç¸½é¡ ${total_amount})\n"
                f"----------------\n"
                f"ğŸ‘¤ {sender_name}ï¼š${self_amount}\n"
                f"ğŸ‘¤ {target_user_name}ï¼š${split_amount}"
            )
            line_bot_api.reply_message(event.reply_token, TextSendMessage(text=reply_text))
            
        except Exception as e:
            app.logger.error(f"DB Error: {e}")
            line_bot_api.reply_message(event.reply_token, TextSendMessage(text="âŒ æ‹†å¸³å¤±æ•—ï¼Œè³‡æ–™åº«éŒ¯èª¤"))
        return


    # === åŠŸèƒ½ Cï¼šä¸€èˆ¬è¨˜å¸³ (åŒ…å«å¹«åˆ¥äººè¨˜å…¨é¡) ===
    pattern_general = r'^(?:(\d{4}[-/]\d{1,2}[-/]\d{1,2})\s*)?(.+?)\s*(\d+)$'
    match = re.match(pattern_general, msg)
    
    if match:
        date_str = match.group(1)
        text_content = match.group(2).strip()
        amount = int(match.group(3))
        
        tokens = text_content.split(None, 1)
        final_user_id = sender_id
        item = text_content 
        
        if len(tokens) == 2:
            possible_name = tokens[0]
            remaining_text = tokens[1]
            found_id = get_user_id_by_name(possible_name)
            if found_id:
                final_user_id = found_id
                item = remaining_text 

        created_at_val = "now()" 
        display_date = "ä»Šå¤©"
        if date_str:
            try:
                datetime.strptime(date_str, "%Y-%m-%d")
                created_at_val = f"'{date_str} 12:00:00'" 
                display_date = date_str
            except ValueError:
                line_bot_api.reply_message(event.reply_token, TextSendMessage(text="âŒ æ—¥æœŸæ ¼å¼è«‹ç”¨ YYYY-MM-DD"))
                return

        try:
            conn = get_db_connection()
            cur = conn.cursor()
            
            if created_at_val == "now()":
                cur.execute(
                    "INSERT INTO expenses (user_id, item, amount) VALUES (%s, %s, %s)",
                    (final_user_id, item, amount)
                )
            else:
                cur.execute(
                    "INSERT INTO expenses (user_id, item, amount, created_at) VALUES (%s, %s, %s, %s)",
                    (final_user_id, item, amount, date_str)
                )
                
            conn.commit()
            
            final_user_name = get_user_name(final_user_id)
            if final_user_id == sender_id:
                final_user_name = "ä½ " 

            cur.close()
            conn.close()
            
            reply_msg = f"âœ… å·²è¨˜éŒ„ï¼\nğŸ“… æ™‚é–“ï¼š{display_date}\nğŸ‘¤ ä»˜æ¬¾ï¼š{final_user_name}\nğŸ›’ é …ç›®ï¼š{item}\nğŸ’° é‡‘é¡ï¼š${amount}"
            line_bot_api.reply_message(event.reply_token, TextSendMessage(text=reply_msg))
            
        except Exception as e:
            app.logger.error(f"Database Error: {e}")
            line_bot_api.reply_message(event.reply_token, TextSendMessage(text="âŒ è¨˜å¸³å¤±æ•—ï¼Œè³‡æ–™åº«å‡ºéŒ¯äº†ã€‚"))
        return

    # === åŠŸèƒ½ Dï¼šæŸ¥è©¢çµç®— (å…¨é«” or å€‹äºº) ===
    # Regex: (Name)?\s*çµç®—
    match_settle = re.match(r'^(?:(.+?)\s*)?çµç®—$', msg)
    
    if match_settle:
        specific_name = match_settle.group(1) # None if "çµç®—", "Name" if "Name çµç®—"
        
        try:
            conn = get_db_connection()
            cur = conn.cursor()
            
            if specific_name:
                # --- å€‹äººçµç®— ---
                target_uid = get_user_id_by_name(specific_name)
                # Allow "æˆ‘ çµç®—"
                if specific_name == "æˆ‘":
                    target_uid = sender_id
                    specific_name = get_user_name(sender_id)

                if not target_uid:
                     line_bot_api.reply_message(event.reply_token, TextSendMessage(text=f"âŒ æ‰¾ä¸åˆ°ã€Œ{specific_name}ã€ï¼è«‹ç¢ºèªåå­—æœ‰è¨»å†Šéã€‚"))
                     return

                cur.execute("""
                    SELECT created_at, item, amount 
                    FROM expenses 
                    WHERE user_id = %s
                    ORDER BY created_at ASC
                """, (target_uid,))
                details = cur.fetchall()
                
                if not details:
                     line_bot_api.reply_message(event.reply_token, TextSendMessage(text=f"ğŸ‘¤ {specific_name} ç›®å‰é‚„æ²’æœ‰æ¶ˆè²»ç´€éŒ„å–”ï¼"))
                     return

                reply_text = f"ğŸ‘¤ {specific_name} çš„æ¶ˆè²»æ˜ç´°ï¼š\n"
                total = 0
                for row in details:
                    dt = row[0]
                    item = row[1]
                    amt = row[2]
                    total += amt
                    date_str = dt.strftime("%m/%d %H:%M")
                    reply_text += f"{date_str}: {item} ${amt}\n"
                
                reply_text += "----------------\n"
                reply_text += f"ğŸ’° å€‹äººç¸½æ”¯å‡º: ${total}"

            else:
                # --- å…¨é«”çµç®— ---
                cur.execute("""
                    SELECT e.created_at, e.user_id, e.item, e.amount 
                    FROM expenses e 
                    ORDER BY e.created_at ASC
                """)
                details = cur.fetchall()
                
                cur.execute("SELECT user_id, display_name FROM users")
                users_raw = cur.fetchall()
                user_map = {u[0]: u[1] for u in users_raw}
                
                if not details:
                    line_bot_api.reply_message(event.reply_token, TextSendMessage(text="ç›®å‰é‚„æ²’æœ‰ä»»ä½•æ¶ˆè²»ç´€éŒ„å–”ï¼"))
                    return
                
                reply_text = "ğŸ“ å…¨é«”æ¶ˆè²»æ˜ç´°ï¼š\n"
                spending_map = {} 
                total_all = 0
                
                for row in details:
                    dt = row[0]
                    uid = row[1]
                    item = row[2]
                    amt = row[3]
                    
                    total_all += amt
                    spending_map[uid] = spending_map.get(uid, 0) + amt
                    
                    date_str = dt.strftime("%m/%d %H:%M")
                    name = user_map.get(uid, get_user_name(uid))
                    
                    reply_text += f"{date_str} {name}: {item} ${amt}\n"
                
                reply_text += "----------------\n"
                reply_text += f"ğŸ’° ç¸½æ”¯å‡º: ${total_all}\n"
                
                for uid in user_map:
                    if uid not in spending_map:
                        spending_map[uid] = 0

                reply_text += "ğŸ‘¤ å„äººçµ±è¨ˆï¼š\n"
                for uid, amt in spending_map.items():
                    name = user_map.get(uid, get_user_name(uid))
                    reply_text += f"{name}: ${amt}\n"

            cur.close()
            conn.close()
            line_bot_api.reply_message(event.reply_token, TextSendMessage(text=reply_text))

        except Exception as e:
            app.logger.error(f"Error: {e}")
            line_bot_api.reply_message(event.reply_token, TextSendMessage(text="âŒ çµç®—ç™¼ç”ŸéŒ¯èª¤"))
        return

    # === åŠŸèƒ½ Eï¼šæ¸…é™¤æ‰€æœ‰è³‡æ–™ (æŒ‡ä»¤ï¼šæ¸…é™¤) ===
    if msg == "æ¸…é™¤":
        try:
            conn = get_db_connection()
            cur = conn.cursor()
            cur.execute("DELETE FROM expenses")
            conn.commit()
            cur.close()
            conn.close()
            line_bot_api.reply_message(event.reply_token, TextSendMessage(text="ğŸ—‘ï¸ å·²æ¸…é™¤æ‰€æœ‰è¨˜å¸³è³‡æ–™ï¼\nä¸€åˆ‡é‡æ–°é–‹å§‹ âœ¨"))
        except Exception as e:
            app.logger.error(f"DB Error: {e}")
        return

@app.route("/", methods=['GET'])
def health_check():
    return "Bot is running!", 200

if __name__ == "__main__":
    port = int(os.environ.get('PORT', 5000))
    app.run(host='0.0.0.0', port=port)
