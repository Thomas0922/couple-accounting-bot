import os
import re
import psycopg2
import logging
from flask import Flask, request, abort
from linebot import LineBotApi, WebhookHandler
from linebot.exceptions import InvalidSignatureError, LineBotApiError
from linebot.models import MessageEvent, TextMessage, TextSendMessage, JoinEvent

# è¨­å®š Log é¡¯ç¤º (æ–¹ä¾¿é™¤éŒ¯)
logging.basicConfig(level=logging.INFO)
app = Flask(__name__)

# === 1. å¾ç’°å¢ƒè®Šæ•¸è®€å–è¨­å®š ===
LINE_CHANNEL_ACCESS_TOKEN = os.environ.get('LINE_CHANNEL_ACCESS_TOKEN')
LINE_CHANNEL_SECRET = os.environ.get('LINE_CHANNEL_SECRET')
DATABASE_URL = os.environ.get('DATABASE_URL')

# åˆå§‹åŒ– Line Bot
line_bot_api = LineBotApi(LINE_CHANNEL_ACCESS_TOKEN)
handler = WebhookHandler(LINE_CHANNEL_SECRET)

# === 2. è³‡æ–™åº«é€£ç·šè¼”åŠ©å‡½å¼ ===
def get_db_connection():
    conn = psycopg2.connect(DATABASE_URL)
    return conn

# === 3. åˆå§‹åŒ–è³‡æ–™åº« (è‡ªå‹•å»ºç«‹ä½¿ç”¨è€…è¡¨) ===
def init_db():
    try:
        conn = get_db_connection()
        cur = conn.cursor()
        # å»ºç«‹ users è¡¨ (å¦‚æœä¸å­˜åœ¨)
        cur.execute("""
            CREATE TABLE IF NOT EXISTS users (
                user_id TEXT PRIMARY KEY,
                display_name TEXT NOT NULL
            );
        """)
        # ç¢ºä¿ expenses è¡¨å­˜åœ¨
        cur.execute("""
            CREATE TABLE IF NOT EXISTS expenses (
                id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                user_id TEXT NOT NULL,
                item TEXT NOT NULL,
                amount INTEGER NOT NULL,
                created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('asia/taipei', now())
            );
        """)
        conn.commit()
        cur.close()
        conn.close()
        print("è³‡æ–™åº«åˆå§‹åŒ–å®Œæˆï¼")
    except Exception as e:
        print(f"è³‡æ–™åº«åˆå§‹åŒ–å¤±æ•—: {e}")

# æ‡‰ç”¨ç¨‹å¼å•Ÿå‹•æ™‚åŸ·è¡Œä¸€æ¬¡åˆå§‹åŒ–
with app.app_context():
    init_db()

# === 4. è¼”åŠ©å‡½å¼ï¼šå–å¾—ç”¨æˆ¶é¡¯ç¤ºåç¨± ===
def get_user_name(user_id):
    # 1. å…ˆå¾è³‡æ–™åº«æ‰¾ (å„ªå…ˆä½¿ç”¨ä½¿ç”¨è€…è‡ªå·±è¨­å®šçš„åå­—)
    try:
        conn = get_db_connection()
        cur = conn.cursor()
        cur.execute("SELECT display_name FROM users WHERE user_id = %s", (user_id,))
        result = cur.fetchone()
        cur.close()
        conn.close()
        if result:
            return result[0]
    except Exception as e:
        app.logger.error(f"æŸ¥è©¢ä½¿ç”¨è€…åç¨±å¤±æ•—: {e}")

    # 2. å¦‚æœè³‡æ–™åº«æ²’æœ‰ï¼Œå˜—è©¦å• LINE (å¦‚æœæ²’åŠ å¥½å‹å¯èƒ½æœƒå¤±æ•—)
    try:
        profile = line_bot_api.get_profile(user_id)
        return profile.display_name
    except:
        return f"ç”¨æˆ¶({user_id[:4]})"

@app.route("/callback", methods=['POST'])
def callback():
    signature = request.headers.get('X-Line-Signature', '')
    body = request.get_data(as_text=True)
    app.logger.info(f"Request body: {body}")

    try:
        handler.handle(body, signature)
    except InvalidSignatureError:
        app.logger.error("Invalid signature.")
        abort(400)
    return 'OK'

# === åŠ å…¥ç¾¤çµ„æ™‚çš„æ­¡è¿è© ===
@handler.add(JoinEvent)
def handle_join(event):
    welcome_msg = (
        "å¤§å®¶å¥½ï¼æˆ‘æ˜¯æƒ…ä¾¶è¨˜å¸³å°å¹«æ‰‹ â¤ï¸\n"
        "ç‚ºäº†é¡¯ç¤ºæ­£ç¢ºçš„åå­—ï¼Œè«‹å¤§å®¶å…ˆå‘Šè¨´æˆ‘ä½ æ˜¯èª°ã€‚\n\n"
        "è«‹è¼¸å…¥ï¼šæˆ‘æ˜¯ ä½ çš„åå­—\n"
        "ä¾‹å¦‚ï¼šæˆ‘æ˜¯ è€å…¬"
    )
    line_bot_api.reply_message(event.reply_token, TextSendMessage(text=welcome_msg))

@handler.add(MessageEvent, message=TextMessage)
def handle_message(event):
    msg = event.message.text.strip()
    user_id = event.source.user_id
    
    # === åŠŸèƒ½ Aï¼šè¨»å†Šåå­— (æ ¼å¼ï¼šæˆ‘æ˜¯ xxx) ===
    if msg.startswith("æˆ‘æ˜¯"):
        name = msg[2:].strip()
        if name:
            try:
                conn = get_db_connection()
                cur = conn.cursor()
                # ä½¿ç”¨ UPSERT (æœ‰å°±æ›´æ–°ï¼Œæ²’æœ‰å°±æ–°å¢)
                cur.execute("""
                    INSERT INTO users (user_id, display_name) 
                    VALUES (%s, %s)
                    ON CONFLICT (user_id) 
                    DO UPDATE SET display_name = EXCLUDED.display_name;
                """, (user_id, name))
                conn.commit()
                cur.close()
                conn.close()
                line_bot_api.reply_message(event.reply_token, TextSendMessage(text=f"âœ… æ­¡è¿ {name}ï¼åå­—è¨­å®šæˆåŠŸï¼"))
            except Exception as e:
                app.logger.error(f"è¨­å®šåå­—å¤±æ•—: {e}")
                line_bot_api.reply_message(event.reply_token, TextSendMessage(text="âŒ è¨­å®šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚"))
        return

    # === åŠŸèƒ½ Bï¼šè¨˜å¸³ (æ ¼å¼ï¼šé …ç›® é‡‘é¡) ===
    match = re.match(r'^(.+?)\s+(\d+)$', msg)
    if match:
        item = match.group(1)
        amount = int(match.group(2))
        
        try:
            conn = get_db_connection()
            cur = conn.cursor()
            cur.execute(
                "INSERT INTO expenses (user_id, item, amount) VALUES (%s, %s, %s)",
                (user_id, item, amount)
            )
            conn.commit()
            cur.close()
            conn.close()
            
            # å–å¾—ç”¨æˆ¶åç¨±
            user_name = get_user_name(user_id)
            reply_text = f"âœ… {user_name} è¨˜å¸³æˆåŠŸï¼\né …ç›®ï¼š{item}\né‡‘é¡ï¼š${amount}"
        except Exception as e:
            app.logger.error(f"Database Error: {e}")
            reply_text = "âŒ è¨˜å¸³å¤±æ•—ï¼Œè³‡æ–™åº«é€£ç·šå¯èƒ½æœ‰å•é¡Œã€‚"
            
        line_bot_api.reply_message(event.reply_token, TextSendMessage(text=reply_text))
        return

    # === åŠŸèƒ½ Cï¼šæŸ¥è©¢çµç®— (æŒ‡ä»¤ï¼šçµç®—) ===
    if msg == "çµç®—":
        try:
            conn = get_db_connection()
            cur = conn.cursor()
            cur.execute("SELECT user_id, SUM(amount) FROM expenses GROUP BY user_id")
            rows = cur.fetchall()
            cur.close()
            conn.close()
            
            if not rows:
                reply_text = "ç›®å‰é‚„æ²’æœ‰ä»»ä½•æ¶ˆè²»ç´€éŒ„å–”ï¼"
            else:
                reply_text = "ğŸ“Š æœ¬æœŸæ¶ˆè²»çµ±è¨ˆï¼š\n"
                total_all = 0
                
                for row in rows:
                    target_user_id = row[0]
                    total = row[1]
                    total_all += total
                    
                    # å–å¾—çœŸå¯¦æš±ç¨±
                    display_name = get_user_name(target_user_id)
                    reply_text += f"{display_name}: ${total}\n"
                
                reply_text += f"----------------\nğŸ’° ç¸½æ”¯å‡º: ${total_all}"
                    
        except Exception as e:
            app.logger.error(f"Database Error: {e}")
            reply_text = "âŒ æŸ¥è©¢å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚"
            
        line_bot_api.reply_message(event.reply_token, TextSendMessage(text=reply_text))
        return

    # === åŠŸèƒ½ Dï¼šæ¸…é™¤æ‰€æœ‰è³‡æ–™ (æŒ‡ä»¤ï¼šæ¸…é™¤) ===
    if msg == "æ¸…é™¤":
        try:
            conn = get_db_connection()
            cur = conn.cursor()
            cur.execute("DELETE FROM expenses")
            conn.commit()
            cur.close()
            conn.close()
            reply_text = "ğŸ—‘ï¸ å·²æ¸…é™¤æ‰€æœ‰è¨˜å¸³è³‡æ–™ï¼\nä¸€åˆ‡é‡æ–°é–‹å§‹ âœ¨"
        except Exception as e:
            app.logger.error(f"Database Error: {e}")
            reply_text = "âŒ æ¸…é™¤å¤±æ•—ã€‚"
            
        line_bot_api.reply_message(event.reply_token, TextSendMessage(text=reply_text))
        return

@app.route("/", methods=['GET'])
def health_check():
    return "Bot is running!", 200

if __name__ == "__main__":
    port = int(os.environ.get('PORT', 5000))
    app.run(host='0.0.0.0', port=port)
